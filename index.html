<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Helvetica Neue", sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; line-height: 1.6; }
    h1 { text-align: center; color: #5d4037; margin-bottom: 30px; }
    .question { margin: 12px 0; }
    button {
      display: block; margin: 20px auto; padding: 12px 24px;
      background: #4CAF50; color: white; border: none; border-radius: 6px;
      font-size: 16px; cursor: pointer; transition: opacity 0.2s;
    }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    #result { display: none; margin-top: 30px; }
    .chart-container { height: 300px; margin: 20px 0; position: relative; }
    pre { background: #f9f9f9; padding: 12px; border-radius: 4px; overflow: auto; font-size: 12px; }
    .error { color: #d32f2f; text-align: center; margin: 10px 0; }
  </style>
</head>
<body>

<h1>âœ¨ æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€æµ‹è¯•</h1>

<div class="question">
  <p><label><input type="checkbox" id="q1"> æˆ‘å¸¸æ„Ÿåˆ°å†…åœ¨æœ‰å¼ºçƒˆçš„è¡¨è¾¾æ¬²æˆ–åˆ›é€ å†²åŠ¨ï¼ˆç‚æ˜ï¼‰</label></p>
  <p><label><input type="checkbox" id="q2"> æˆ‘å€¾å‘äºåœ¨æ²‰é»˜ä¸­ç§¯è“„åŠ›é‡ï¼Œä¸è½»æ˜“å¤–æ˜¾ï¼ˆæ½œå¹½ï¼‰</label></p>
  <p><label><input type="checkbox" id="q3"> æˆ‘å¯¹æ–°äº‹ç‰©ã€æ–°å˜åŒ–æœ‰å¤©ç„¶çš„å¥½å¥‡ä¸é€‚åº”åŠ›ï¼ˆèŒåŠ¨ï¼‰</label></p>
  <p><label><input type="checkbox" id="q4"> æˆ‘é‡è§†ç»“æ„ã€ç§©åºä¸é•¿æœŸç§¯ç´¯ï¼ˆæ•¦åšï¼‰</label></p>
  <p><label><input type="checkbox" id="q5"> æˆ‘å®¹æ˜“æ„ŸçŸ¥åˆ°ä»–äººæœªè¨€æ˜çš„æƒ…ç»ªæˆ–æ°›å›´ï¼ˆé€šæ„Ÿï¼‰</label></p>
  <p><label><input type="checkbox" id="q6"> æˆ‘ä¹ æƒ¯é€šè¿‡é€»è¾‘æ¨æ¼”ç†è§£ä¸–ç•Œï¼ˆæ¾„æ¾ˆï¼‰</label></p>
  <p><label><input type="checkbox" id="q7"> æˆ‘çš„ç”Ÿå‘½èŠ‚å¥å¸¸ä¸è‡ªç„¶èŠ‚å¾‹å…±æŒ¯ï¼ˆå½’è—ï¼‰</label></p>
  <p><label><input type="checkbox" id="q8"> æˆ‘åœ¨ç¾¤ä½“ä¸­å¸¸æˆä¸ºå‡èšæˆ–è°ƒå’Œçš„è§’è‰²ï¼ˆå’Œåˆï¼‰</label></p>
  <p><label><input type="checkbox" id="q9"> æˆ‘å¯¹è‰²å½©ã€å…‰å½±ã€æ„å›¾ç‰¹åˆ«æ•æ„Ÿï¼ˆè§†è§‰ï¼‰</label></p>
  <p><label><input type="checkbox" id="q10"> æˆ‘å®¹æ˜“è¢«å£°éŸ³ã€è¯­è°ƒã€èŠ‚å¥è§¦åŠ¨ï¼ˆå¬è§‰ï¼‰</label></p>
</div>

<button id="generateBtn" onclick="generateTS()">âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€</button>
<div id="errorMessage" class="error"></div>

<div id="result">
  <h2>ğŸŒ¿ ä½ çš„ä¸‰å…ƒçŠ¶æ€</h2>
  <p><strong>å½“å‰äº”æ¯å¾‹ç¯ï¼š</strong><span id="rhythmText"></span></p>

  <h3>â¼‹ç‚ç„åŸºï¼ˆç”Ÿå‘½èƒ½é‡åˆ†å¸ƒï¼‰</h3>
  <div class="chart-container"><canvas id="qiChart"></canvas></div>

  <h3>äº”è§‰å…‰è½®ï¼ˆæ„è¯†æ„ŸçŸ¥å€¾å‘ï¼‰</h3>
  <div class="chart-container"><canvas id="luminChart"></canvas></div>

  <details>
    <summary>ğŸ“Š åŸå§‹æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰</summary>
    <pre id="rawData"></pre>
  </details>
</div>

<script>
  // ========== å…¨å±€çŠ¶æ€ ==========
  let hasGenerated = false;

  // ========== å·¥å…·å‡½æ•° ==========
  function getCurrentRhythm() {
    const month = new Date().getMonth();
    if (month >= 2 && month <= 4) return "æ˜¾åŒ–";
    if (month >= 5 && month <= 7) return "æ¶µè‚²";
    if (month >= 8 && month <= 10) return "æ•›è—";
    return "å½’å…ƒ";
  }

  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    setTimeout(() => document.getElementById('errorMessage').textContent = '', 5000);
  }

  // ========== ä¸»é€»è¾‘ ==========
  async function generateTS() {
    if (hasGenerated) {
      alert("âœ… ä¸‰å…ƒçŠ¶æ€å·²ç”Ÿæˆã€‚\nğŸ‘‰ åˆ·æ–°é¡µé¢å³å¯é‡æ–°æµ‹è¯•ã€‚");
      return;
    }

    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';
    showError('');

    try {
      const answers = {};
      for (let i = 1; i <= 10; i++) {
        answers[`q${i}`] = document.getElementById(`q${i}`).checked;
      }

      const response = await fetch('/api/tsos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(answers)
      });

      if (!response.ok) {
        const errText = await response.text();
        try {
          const errJson = JSON.parse(errText);
          throw new Error(errJson.error || 'è¯·æ±‚å¤±è´¥');
        } catch {
          throw new Error('æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
        }
      }

      const data = await response.json();

      // éªŒè¯æ•°æ®ç»“æ„
      if (!data.qi || !data.lumin || typeof data.rhythm !== 'string') {
        throw new Error('AI è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
      }

      hasGenerated = true;
      renderResult(data);
    } catch (err) {
      console.error('ç”Ÿæˆå¤±è´¥:', err);
      showError('âŒ ' + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
    }
  }

  // ========== æ¸²æŸ“ç»“æœ ==========
  function renderResult(data) {
    document.getElementById('result').style.display = 'block';
    document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
    document.getElementById('rhythmText').textContent = data.rhythm || getCurrentRhythm();

    // å®‰å…¨æ¸²æŸ“å›¾è¡¨ï¼ˆç¡®ä¿ canvas å­˜åœ¨ï¼‰
    requestAnimationFrame(() => {
      try {
        const qiCanvas = document.getElementById('qiChart');
        if (qiCanvas) {
          const qiCtx = qiCanvas.getContext('2d');
          new Chart(qiCtx, {
            type: 'radar',
            data: {
              labels: Object.keys(data.qi),
              datasets: [{
                label: 'å…«ç‚ç„åŸº',
                data: Object.values(data.qi),
                backgroundColor: 'rgba(93, 64, 55, 0.15)',
                borderColor: '#5d4037',
                borderWidth: 2,
                pointBackgroundColor: '#5d4037'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { r: { min: 30, max: 80 } },
              plugins: { legend: { display: true, position: 'top' } }
            }
          });
        }

        const luminCanvas = document.getElementById('luminChart');
        if (luminCanvas) {
          const luminCtx = luminCanvas.getContext('2d');
          new Chart(luminCtx, {
            type: 'radar',
            data: {
              labels: Object.keys(data.lumin),
              datasets: [{
                label: 'äº”è§‰å…‰è½®',
                data: Object.values(data.lumin),
                backgroundColor: 'rgba(76, 175, 80, 0.15)',
                borderColor: '#4CAF50',
                borderWidth: 2,
                pointBackgroundColor: '#4CAF50'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { r: { min: 30, max: 80 } },
              plugins: { legend: { display: true, position: 'top' } }
            }
          });
        }
      } catch (chartErr) {
        console.warn('å›¾è¡¨æ¸²æŸ“å¤±è´¥ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰:', chartErr);
        showError('âš ï¸ å›¾è¡¨æ¸²æŸ“å¼‚å¸¸ï¼Œä½†æ•°æ®å·²æˆåŠŸç”Ÿæˆ');
      }
    });
  }
</script>

</body>
</html>
