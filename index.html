<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #fdf6e3;
      --card-bg: white;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.05);
      --border-color: #d9d9d9;
      --text-dark: #2d2d2d;
      --text-light: #666;
      --btn-green: #4CAF50;
      --btn-blue: #2196F3;
      --icon-size: 1.2em;
      --font-family: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-dark);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.7;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    h1, h2, h3 {
      color: var(--text-dark);
    }

    h1 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    .logo {
      display: inline-block;
      margin-right: 10px;
      color: #FFD700;
      font-size: 1.5em;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 1.4rem;
      font-weight: 600;
      color: #4a3a32;
    }

    .card-subtitle {
      text-align: center;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .question-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .question-item {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }

    .question-item input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }

    .question-text {
      font-size: 1rem;
      color: var(--text-dark);
    }

    .btn {
      display: block;
      width: 240px;
      margin: 30px auto 0;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
    }

    .btn-green {
      background: var(--btn-green);
    }

    .btn-green:hover {
      background: #45a049;
    }

    .btn-blue {
      background: var(--btn-blue);
    }

    .btn-blue:hover {
      background: #1976d2;
    }

    .deep-card {
      border: 2px solid var(--btn-blue);
      background: transparent;
      padding: 30px;
    }

    .result-container {
      margin-top: 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    #deepContainer {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    #optionsBox button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
    }

    #optionsBox button:hover {
      background: #eef2ff;
      border-color: #a3b1ff;
    }

    #yearbookOutput {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #4CAF50;
      white-space: pre-wrap;
      font-family: "Songti SC", serif;
      color: var(--text-dark);
    }

    /* TSI æ ·å¼ */
    #tsi-panel, #decision-card {
      margin-top: 24px;
      padding: 16px;
      border-radius: 12px;
    }
    #tsi-fill {
      height: 10px;
      border-radius: 5px;
      transition: width 0.5s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="logo">âœ¨</span> æ¯å£¤ Â· X-TSOS ä¸‰å…ƒçŠ¶æ€</h1>

    <!-- åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ -->
    <div class="card">
      <div class="card-title">
        <span>ğŸŒ±</span> <span>åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        10é¢˜ Â· 2åˆ†é’Ÿ Â· æŠŠæ¡å½“ä¸‹çŠ¶æ€è½®å»“
      </div>
      <form id="tsosForm">
        <ul class="question-list">
          <li class="question-item">
            <input type="checkbox" name="q1" />
            <span class="question-text">æˆ‘å¸¸å› è¿½æ±‚å®Œç¾è€Œè¿Ÿè¿Ÿä¸å¼€å§‹è¡ŒåŠ¨ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q2" />
            <span class="question-text">æˆ‘å¾ˆéš¾å¯¹ä»–äººè¯´â€œä¸â€ï¼Œå³ä½¿è‡ªå·±å·²ç»å¾ˆç´¯ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q3" />
            <span class="question-text">æˆ‘æœ€è¿‘çƒ­æƒ…é«˜æ¶¨ï¼Œä½†æ„Ÿåˆ°èº«å¿ƒç–²æƒ«ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q4" />
            <span class="question-text">é¢å¯¹å˜åŒ–ï¼Œæˆ‘å®¹æ˜“é™·å…¥åå¤æ€è™‘ï¼Œéš¾ä»¥å†³æ–­ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q5" />
            <span class="question-text">æˆ‘ä¹ æƒ¯æŠŠæƒ…ç»ªè—èµ·æ¥ï¼Œè¯´â€œæˆ‘æ²¡äº‹â€ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q6" />
            <span class="question-text">æˆ‘å¯¹å­£èŠ‚æˆ–å¤©æ°”å˜åŒ–ç‰¹åˆ«æ•æ„Ÿï¼ˆå¦‚æ˜¥å›°ã€ç§‹ç‡¥ï¼‰ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q7" />
            <span class="question-text">å³ä½¿æ²¡äººè®¤å¯ï¼Œæˆ‘ä¹Ÿæ„¿æ„åšæŒåšä¸€ä»¶å°äº‹ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q8" />
            <span class="question-text">æˆ‘å¸¸æ„Ÿåˆ°æ€ç»ªçº·é£ï¼Œéš¾ä»¥å®‰é™ä¸‹æ¥ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q9" />
            <span class="question-text">åœ¨äººç¾¤ä¸­ï¼Œæˆ‘å®¹æ˜“å¸æ”¶ä»–äººçš„æƒ…ç»ªï¼Œäº‹åéœ€è¦ç‹¬å¤„æ¢å¤ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q10" />
            <span class="question-text">æˆ‘ç›¸ä¿¡æ—¥å¸¸çäº‹ä¸­è—ç€æ„ä¹‰ï¼Œå“ªæ€•åªæ˜¯ç…®ä¸€æ¯èŒ¶ã€‚</span>
          </li>
        </ul>
        <button type="submit" class="btn btn-green">
          âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€
        </button>
      </form>
    </div>

    <!-- å…±æ˜¾ Â· æ·±åº¦ç‰ˆ -->
    <div class="card deep-card">
      <div class="card-title">
        <span>ğŸŒŒ</span> <span>å…±æ˜¾ Â· æ·±åº¦ç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        åŠ¨æ€è¿½é—® Â· 42é¢˜èµ· Â· é€¼è¿‘å¿ƒæ€§æœ¬çœŸ
      </div>
      <button type="button" class="btn btn-blue" onclick="initDeepScreening()">
        å¯åŠ¨ã€Œè§‚è±¡å…¥å¾®ã€ä¸‰é˜¶å…±æ˜¾åˆç­›
      </button>
    </div>
  </div>

  <!-- æ·±åº¦ç­›æŸ¥ç•Œé¢ -->
  <div id="deepContainer" style="display:none;">
    <div style="text-align:center; margin-bottom:10px; color:#666;">
      è§‚è±¡å…¥å¾® Â· ç¬¬<span id="stageNum">1</span>é˜¶ | å·²ç­”ï¼š<span id="ansCount">0</span> é¢˜
    </div>
    <div id="questionText" style="font-size:18px; min-height:60px; margin-bottom:20px;"></div>
    <div id="optionsBox"></div>
    
    <button id="backBtn" style="
      display: none;
      margin-top: 16px;
      padding: 8px 16px;
      background: #e0e0e0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #555;
    ">â†©ï¸ è¿”å›ä¸Šä¸€é¢˜</button>
  </div>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <div id="result" style="display:none; max-width:800px; margin:0 auto;"></div>
  <div id="yearbookOutput" style="display:none;"></div>

  <script>
    // ========== èŠ‚æ°”è®¡ç®—å‡½æ•°ï¼ˆå†…è”ï¼‰ ==========
    function getCurrentSolarTerm(date = new Date()) {
      const terms = [
        'å°å¯’','å¤§å¯’','ç«‹æ˜¥','é›¨æ°´','æƒŠè›°','æ˜¥åˆ†','æ¸…æ˜','è°·é›¨',
        'ç«‹å¤','å°æ»¡','èŠ’ç§','å¤è‡³','å°æš‘','å¤§æš‘','ç«‹ç§‹','å¤„æš‘',
        'ç™½éœ²','ç§‹åˆ†','å¯’éœ²','éœœé™','ç«‹å†¬','å°é›ª','å¤§é›ª','å†¬è‡³'
      ];
      const offsets = [5,20,39,54,70,85,101,116,132,147,163,178,194,209,225,240,256,271,287,302,318,333,349,364];
      const year = date.getFullYear();
      const startOfYear = new Date(year, 0, 1);
      const dayOfYear = Math.floor((date - startOfYear) / (1000 * 60 * 60 * 24)) + 1;

      for (let i = 0; i < 24; i++) {
        const currentOffset = offsets[i];
        const nextOffset = i < 23 ? offsets[i + 1] : offsets[0] + 365;
        if (dayOfYear >= currentOffset && dayOfYear < nextOffset) {
          return terms[i];
        }
      }
      return 'å°å¯’';
    }
  </script>

  <script type="module">
    import { DeepScreeningEngine } from './src/engine/DeepScreeningEngine.js';
    const { GuidanceRules_zh } = await import('./src/guidance/rules/zh.js');

    function generateGuidanceFromResult(result, options = {}) {
      const { qi, lumin, rhythm } = result;
      const maxCount = options.maxCount || 5;
      const topQi = Object.entries(qi).sort((a, b) => b[1] - a[1]).slice(0, 2).map(([k]) => k);
      const topLumin = Object.entries(lumin).sort((a, b) => b[1] - a[1])[0]?.[0];
      const matches = [];
      for (const rule of GuidanceRules_zh[rhythm] || []) {
        let score = 0;
        if (rule.lumin === topLumin) score += 2;
        if (topQi.includes(rule.qi[0])) score += 1;
        if (topQi.includes(rule.qi[1])) score += 1;
        if (score > 0) matches.push({ ...rule, score });
      }
      matches.sort((a, b) => b.score - a.score);
      return { suggestions: matches.slice(0, maxCount) };
    }

    // ========== åˆç­›æäº¤ï¼ˆæ–°å¢èŠ‚æ°”ä¸Šä¸‹æ–‡ï¼‰ ==========
    document.getElementById('tsosForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const answers = {};
      for (let [key] of formData.entries()) {
        answers[key] = true;
      }

      // ğŸ”¥ æ³¨å…¥èŠ‚æ°”ä¸Šä¸‹æ–‡
      const context = { solarTerm: getCurrentSolarTerm() };

      const btn = e.submitter;
      btn.disabled = true;
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers, context })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data = await response.json();
        showResult(data);
      } catch (err) {
        console.error('âŒ åˆç­›å¤±è´¥:', err.message);
        alert('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
      }
    });

    // ========== æ·±åº¦ç­›æŸ¥ï¼ˆæš‚ä¸åŠ èŠ‚æ°”ï¼Œå¯åç»­æ‰©å±•ï¼‰ ==========
    let deepEngine = null;
    window.initDeepScreening = async function() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('deepContainer').style.display = 'block';
      deepEngine = new DeepScreeningEngine();
      try {
        await deepEngine.loadQuestionBank('./data/DQ420.json');
        renderCurrentQuestion();
      } catch (err) {
        alert('é¢˜åº“åŠ è½½å¤±è´¥ï¼š' + err.message);
        console.error(err);
      }
    };

    function renderCurrentQuestion() {
      const q = deepEngine.getCurrentQuestion();
      if (!q || deepEngine.isCompleted()) {
        finishDeepScreening();
        return;
      }
      document.getElementById('questionText').textContent = q.text;
      document.getElementById('stageNum').textContent = q.stage || 1;
      document.getElementById('ansCount').textContent = deepEngine.answerHistory.length;
      const optsBox = document.getElementById('optionsBox');
      optsBox.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.textContent = opt.label || opt;
        btn.onclick = () => {
          deepEngine.submitAnswer(idx);
          renderCurrentQuestion();
        };
        optsBox.appendChild(btn);
      });
      const backBtn = document.getElementById('backBtn');
      backBtn.style.display = deepEngine.canGoBack() ? 'inline-block' : 'none';
    }

    document.getElementById('backBtn').addEventListener('click', () => {
      if (deepEngine && deepEngine.goBack()) {
        renderCurrentQuestion();
      }
    });

    function finishDeepScreening() {
      const result = deepEngine.getNormalizedResult();
      showResult(result);
    }

    // ========== ç»“æœå±•ç¤ºï¼ˆæ”¯æŒèŠ‚æ°”ä¿¡æ¯ï¼‰ ==========
    function showResult(data) {
      document.getElementById('deepContainer').style.display = 'none';
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<h2 style="text-align:center;">ğŸ“Š ä½ çš„ X-TSOS ä¸‰å…ƒç»“æ„</h2>';

      // èŠ‚æ°”ä¸ä¸»å¯¼ç‚ï¼ˆè‹¥å­˜åœ¨ï¼‰
      const meta = data.metadata || {};
      const solarTerm = meta.solarTerm || 'æœªçŸ¥';
      const dominantQi = meta.dominantQi || 'æœªè¯†åˆ«';
      resultDiv.innerHTML += `
        <p style="text-align:center; color:#64748b; margin:10px 0;">
          <small>ğŸ“ å½“å‰èŠ‚æ°”ï¼š${solarTerm} Â· ä¸»å¯¼ç‚ï¼š${dominantQi}</small>
        </p>
      `;

      // å…«ç‚é›·è¾¾å›¾
      const qiCtx = document.createElement('canvas');
      qiCtx.height = 200;
      resultDiv.appendChild(qiCtx);
      new Chart(qiCtx, {
        type: 'radar',
        data: {
          labels: ['åšè½½','èŒåŠ¨','ç‚æ˜','æ¶¦ä¸‹','è‚ƒé™','åˆšå¥','é€šé€','é™å®ˆ'],
          datasets: [{
            label: 'å…«ç‚ç„åŸº',
            data: Object.values(data.qi),
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            pointBackgroundColor: 'rgba(76, 175, 80, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // äº”è§‰å…‰è½®
      const luminCtx = document.createElement('canvas');
      luminCtx.height = 150;
      resultDiv.appendChild(luminCtx);
      new Chart(luminCtx, {
        type: 'radar',
        data: {
          labels: ['å¦‚æ˜¯','ç ´æš—','æ¶“æµ','æ˜ ç…§','æ— å '],
          datasets: [{
            label: 'äº”è§‰å…‰è½®',
            data: Object.values(data.lumin),
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            pointBackgroundColor: 'rgba(33, 150, 243, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // è¡Œä¸ºæŒ‡å¼•
      const guidance = generateGuidanceFromResult(data, { maxCount: 3 });
      const guideEl = document.createElement('div');
      guideEl.innerHTML = `<h3 style="margin-top:30px;">ğŸ’¡ åˆæ­¥è¡Œä¸ºæŒ‡å¯¼</h3>`;
      guidance.suggestions.forEach(sug => {
        const p = document.createElement('p');
        p.innerHTML = `<strong>â†’ ${sug.forward}</strong>`;
        if (sug.reverse) {
          p.innerHTML += `<br><small style="color:#888;">ğŸš« ${sug.reverse}</small>`;
        }
        p.style.margin = '12px 0';
        p.style.padding = '10px';
        p.style.background = '#fafafa';
        p.style.borderRadius = '6px';
        guideEl.appendChild(p);
      });
      resultDiv.appendChild(guideEl);

      // TSI ä¸å†³ç­–å¡
      if (data.TSI !== undefined) {
        const tsiPercent = Math.round(data.TSI * 100);
        let desc = '';
        if (data.TSI < 0.4) {
          desc = 'çŠ¶æ€è„†å¼±ï¼Œå»ºè®®ä¼˜å…ˆè‡ªæˆ‘å…³æ€€ä¸åŸºç¡€æ¥åœ°ç»ƒä¹ ';
        } else if (data.TSI < 0.7) {
          desc = 'çŠ¶æ€å¹³ç¨³ï¼Œå¯å°è¯•æ¸©å’Œè¡ŒåŠ¨æˆ–å¾®ä»»åŠ¡';
        } else {
          desc = 'çŠ¶æ€é«˜èƒ½ï¼Œé€‚åˆæ·±åº¦åˆ›é€ ã€è¡¨è¾¾æˆ–è¿æ¥ä»–äºº';
        }

        const tsiHtml = `
          <div id="tsi-panel" style="background:#f8fafc; border:1px solid #e2e8f0; margin-top:24px; padding:16px; border-radius:12px;">
            <h3 style="margin:0 0 12px 0; color:#1e293b; font-size:1.1em;">ä¸‰å…ƒååŒåº¦ (TSI)</h3>
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
              <div style="flex:1; height:10px; background:#e2e8f0; border-radius:5px; overflow:hidden;">
                <div id="tsi-fill" style="height:100%; background:linear-gradient(to right, #f87171, #60a5fa, #34d399); width:${tsiPercent}%;"></div>
              </div>
              <span style="font-weight:bold; min-width:50px; text-align:right;">${tsiPercent}%</span>
            </div>
            <p style="margin:0; font-size:0.9em; color:#64748b;">${desc}</p>
          </div>

          <div id="decision-card" style="margin-top:16px; padding:14px; background:#f1f5f9; border-radius:10px; border-left:4px solid #4f46e5;">
            <strong style="color:#1e293b;">ä¸ºä½•æ­¤åˆ»æ¨èæ­¤æŒ‡å¼•ï¼Ÿ</strong><br>
            <span style="color:#334155;">${data.decisionCard?.reason || 'ç³»ç»Ÿæ­£åœ¨å­¦ä¹ ä½ çš„çŠ¶æ€æ¨¡å¼...'}</span><br>
            <small style="color:#64748b; margin-top:6px; display:block;">${data.decisionCard?.action || ''}</small>
          </div>
        `;
        resultDiv.innerHTML += tsiHtml;
      }

      // å¹´é‰´æŒ‰é’®
      const yearbookBtn = document.createElement('button');
      yearbookBtn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      yearbookBtn.className = 'btn btn-green';
      yearbookBtn.style.width = 'auto';
      yearbookBtn.style.margin = '20px auto';
      yearbookBtn.onclick = () => generateYearbook(data);
      resultDiv.appendChild(yearbookBtn);
    }

    async function generateYearbook(tsData) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ğŸ–‹ï¸ æ’°å†™ä¸­...';
      try {
        const response = await fetch('/api/yearbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            qi: tsData.qi,
            lumin: tsData.lumin,
            rhythm: tsData.rhythm
          })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
        const output = document.getElementById('yearbookOutput');
        output.textContent = result.yearbook;
        output.style.display = 'block';
      } catch (err) {
        alert('ğŸ“œ å¹´é‰´ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      }
    }
  </script>
</body>
</html>
