<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€åˆç­›</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #fdf6e3;
      --card-bg: white;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.05);
      --border-color: #d9d9d9;
      --text-dark: #2d2d2d;
      --text-light: #666;
      --btn-green: #4CAF50;
      --btn-blue: #2196F3;
      --icon-size: 1.2em;
      --font-family: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-dark);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.7;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #4a3a32;
      font-weight: 600;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    .logo {
      display: inline-block;
      margin-right: 10px;
      color: #FFD700;
      font-size: 1.5em;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 1.4rem;
      font-weight: 600;
      color: #4a3a32;
    }

    .card-title span {
      margin-left: 8px;
    }

    .card-subtitle {
      text-align: center;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .question-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .question-item {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }

    .question-item input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }

    .question-text {
      font-size: 1rem;
      color: var(--text-dark);
    }

    .btn {
      display: block;
      width: 240px;
      margin: 30px auto 0;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-green {
      background: var(--btn-green);
      color: white;
    }

    .btn-green:hover {
      background: #45a049;
    }

    .btn-blue {
      background: var(--btn-blue);
      color: white;
    }

    .btn-blue:hover {
      background: #1976d2;
    }

    .deep-card {
      border: 2px solid var(--btn-blue);
      background: transparent;
      padding: 30px;
    }

    .deep-card .card-title {
      color: var(--btn-blue);
    }

    .deep-card .card-subtitle {
      color: var(--text-light);
    }

    .result-container {
      margin-top: 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="logo">âœ¨</span> æ¯å£¤ Â· X-TSOS ä¸‰å…ƒçŠ¶æ€åˆç­›</h1>

    <!-- åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ -->
    <div class="card">
      <div class="card-title">
        <span>ğŸŒ±</span> <span>åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        10é¢˜ Â· 2åˆ†é’Ÿ Â· æŠŠæ¡å½“ä¸‹çŠ¶æ€è½®å»“
      </div>
      <form id="tsosForm">
        <ul class="question-list">
          <li class="question-item">
            <input type="checkbox" name="q1" />
            <span class="question-text">æˆ‘å¸¸å› è¿½æ±‚å®Œç¾è€Œè¿Ÿè¿Ÿä¸å¼€å§‹è¡ŒåŠ¨ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q2" />
            <span class="question-text">æˆ‘å¾ˆéš¾å¯¹ä»–äººè¯´â€œä¸â€ï¼Œå³ä½¿è‡ªå·±å·²ç»å¾ˆç´¯ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q3" />
            <span class="question-text">æˆ‘æœ€è¿‘çƒ­æƒ…é«˜æ¶¨ï¼Œä½†æ„Ÿåˆ°èº«å¿ƒç–²æƒ«ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q4" />
            <span class="question-text">é¢å¯¹å˜åŒ–ï¼Œæˆ‘å®¹æ˜“é™·å…¥åå¤æ€è™‘ï¼Œéš¾ä»¥å†³æ–­ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q5" />
            <span class="question-text">æˆ‘ä¹ æƒ¯æŠŠæƒ…ç»ªè—èµ·æ¥ï¼Œè¯´â€œæˆ‘æ²¡äº‹â€ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q6" />
            <span class="question-text">æˆ‘å¯¹å­£èŠ‚æˆ–å¤©æ°”å˜åŒ–ç‰¹åˆ«æ•æ„Ÿï¼ˆå¦‚æ˜¥å›°ã€ç§‹ç‡¥ï¼‰ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q7" />
            <span class="question-text">å³ä½¿æ²¡äººè®¤å¯ï¼Œæˆ‘ä¹Ÿæ„¿æ„åšæŒåšä¸€ä»¶å°äº‹ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q8" />
            <span class="question-text">æˆ‘å¸¸æ„Ÿåˆ°æ€ç»ªçº·é£ï¼Œéš¾ä»¥å®‰é™ä¸‹æ¥ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q9" />
            <span class="question-text">åœ¨äººç¾¤ä¸­ï¼Œæˆ‘å®¹æ˜“å¸æ”¶ä»–äººçš„æƒ…ç»ªï¼Œäº‹åéœ€è¦ç‹¬å¤„æ¢å¤ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q10" />
            <span class="question-text">æˆ‘ç›¸ä¿¡æ—¥å¸¸çäº‹ä¸­è—ç€æ„ä¹‰ï¼Œå“ªæ€•åªæ˜¯ç…®ä¸€æ¯èŒ¶ã€‚</span>
          </li>
        </ul>
        <button type="submit" class="btn btn-green">
          âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€
        </button>
      </form>
    </div>

    <!-- å…±æ˜¾ Â· æ·±åº¦ç‰ˆ -->
    <div class="card deep-card">
      <div class="card-title">
        <span>ğŸŒŒ</span> <span>å…±æ˜¾ Â· æ·±åº¦ç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        åŠ¨æ€è¿½é—® Â· 42é¢˜èµ· Â· é€¼è¿‘å¿ƒæ€§æœ¬çœŸ
      </div>
      <button type="button" class="btn btn-blue" onclick="initDeepScreening()">
        å¯åŠ¨ã€Œè§‚è±¡å…¥å¾®ã€ä¸‰é˜¶å…±æ˜¾åˆç­›
      </button>
    </div>
  </div>

  <!-- ========== æ·±åº¦ç­”é¢˜å®¹å™¨ ========== -->
  <div id="deepContainer" style="display:none;">
    <div class="stage-indicator">è§‚è±¡å…¥å¾® Â· ç¬¬<span id="stageNum">1</span>é˜¶</div>
    <div id="questionText" style="font-size:18px; min-height:60px;"></div>
    <div id="optionsBox"></div>
    <p style="text-align:center; color:#666;">å·²ç­”ï¼š<span id="ansCount">0</span> é¢˜</p>
  </div>

  <!-- ========== ç»“æœåŒºåŸŸ ========== -->
  <div id="result" style="display:none;"></div>
  <div id="yearbookOutput"></div>

  <script type="module">
    // ========== å¼•å…¥æœ¬åœ°å¼•æ“ ==========
    import { DeepScreeningEngine } from './src/engine/DeepScreeningEngine.js';
    import generateGuidanceFromResult from './src/guidance/GuidanceEngine.js';

    // ========== è½»é—®è¡¨å•æäº¤ ==========
    document.getElementById('tsosForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const answers = {};
      for (let [key] of formData.entries()) {
        answers[key] = true;
      }

      const btn = e.submitter;
      btn.disabled = true;
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(answers)
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');

        showResult(data);
      } catch (err) {
        showError('âŒ ' + (err.message || 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'));
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
      }
    });

    // ========== æ·±åº¦æ¨¡å¼ ==========
    let deepEngine = null;

    window.initDeepScreening = async function() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('deepContainer').style.display = 'block';

      deepEngine = new DeepScreeningEngine();
      try {
        await deepEngine.loadQuestionBank();
        renderCurrentQuestion();
      } catch (err) {
        showError('é¢˜åº“åŠ è½½å¤±è´¥ï¼š' + err.message);
        console.error(err);
      }
    };

    function renderCurrentQuestion() {
      const q = deepEngine.getCurrentQuestion();
      if (!q || deepEngine.isCompleted()) {
        finishDeepScreening();
        return;
      }

      document.getElementById('questionText').textContent = q.text;
      const optsBox = document.getElementById('optionsBox');
      optsBox.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.textContent = opt.label || opt;
        btn.onclick = () => {
          deepEngine.submitAnswer(idx);
          document.getElementById('ansCount').textContent = deepEngine.answerCount;
          if (deepEngine.isCompleted()) {
            finishDeepScreening();
          } else {
            renderCurrentQuestion();
          }
        };
        optsBox.appendChild(btn);
      });

      document.getElementById('stageNum').textContent = q.stage || 1;
    }

    function finishDeepScreening() {
      const result = deepEngine.getNormalizedResult();
      showResult(result);
    }

    // ========== ç»“æœæ¸²æŸ“ ==========
    function showResult(data) {
      document.getElementById('deepContainer').style.display = 'none';
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<h2>ğŸ“Š ä½ çš„ X-TSOS ä¸‰å…ƒç»“æ„</h2>';

      // å…«ç‚é›·è¾¾å›¾
      const qiCtx = document.createElement('canvas');
      qiCtx.height = 300;
      resultDiv.appendChild(qiCtx);

      new Chart(qiCtx, {
        type: 'radar',
        data: {
          labels: ['åšè½½','èŒåŠ¨','ç‚æ˜','æ¶¦ä¸‹','è‚ƒé™','åˆšå¥','é€šé€','é™å®ˆ'],
          datasets: [{
            label: 'å…«ç‚ç„åŸº',
            data: [
              data.qi.åšè½½,
              data.qi.èŒåŠ¨,
              data.qi.ç‚æ˜,
              data.qi.æ¶¦ä¸‹,
              data.qi.è‚ƒé™,
              data.qi.åˆšå¥,
              data.qi.é€šé€,
              data.qi.é™å®ˆ
            ],
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            pointBackgroundColor: 'rgba(76, 175, 80, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // äº”è§‰å…‰è½®
      const luminCtx = document.createElement('canvas');
      luminCtx.height = 250;
      resultDiv.appendChild(luminCtx);

      new Chart(luminCtx, {
        type: 'radar',
        data: {
          labels: ['å¦‚æ˜¯','ç ´æš—','æ¶“æµ','æ˜ ç…§','æ— å '],
          datasets: [{
            label: 'äº”è§‰å…‰è½®',
            data: [
              data.lumin.å¦‚æ˜¯,
              data.lumin.ç ´æš—,
              data.lumin.æ¶“æµ,
              data.lumin.æ˜ ç…§,
              data.lumin.æ— å 
            ],
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            pointBackgroundColor: 'rgba(33, 150, 243, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // è¡Œä¸ºæŒ‡å¼•
      const guidance = generateGuidanceFromResult(data, { maxCount: 3 });
      const guideEl = document.createElement('div');
      guideEl.innerHTML = `<h3>ğŸ’¡ è¡Œä¸ºæŒ‡å¼•</h3>`;
      guidance.suggestions.forEach(sug => {
        const p = document.createElement('p');
        p.innerHTML = `<strong>â†’ ${sug.forward}</strong>`;
        if (sug.reverse) {
          p.innerHTML += `<br><small>âš ï¸ ${sug.reverse}</small>`;
        }
        p.style.margin = '10px 0';
        guideEl.appendChild(p);
      });
      resultDiv.appendChild(guideEl);

      // å¹´é‰´æŒ‰é’®
      const yearbookBtn = document.createElement('button');
      yearbookBtn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      yearbookBtn.onclick = () => generateYearbook(data);
      yearbookBtn.style.marginTop = '20px';
      resultDiv.appendChild(yearbookBtn);
    }

    // ========== å¹´é‰´ç”Ÿæˆ ==========
    async function generateYearbook(tsData) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ğŸ–‹ï¸ æ’°å†™ä¸­...';

      try {
        const response = await fetch('/api/yearbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            qi: tsData.qi,
            lumin: tsData.lumin,
            rhythm: tsData.rhythm
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');

        const output = document.getElementById('yearbookOutput');
        output.textContent = result.yearbook;
        output.style.display = 'block';
      } catch (err) {
        showError('ğŸ“œ å¹´é‰´ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      }
    }

    // ========== é”™è¯¯æç¤º ==========
    function showError(msg) {
      let el = document.querySelector('.error');
      if (!el) {
        el = document.createElement('div');
        el.className = 'error';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      setTimeout(() => el.remove(), 5000);
    }
  </script>
</body>
</html>
