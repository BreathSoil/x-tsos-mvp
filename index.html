<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #fdf6e3;
      --card-bg: white;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.05);
      --border-color: #d9d9d9;
      --text-dark: #2d2d2d;
      --text-light: #666;
      --btn-green: #4CAF50;
      --btn-blue: #2196F3;
      --icon-size: 1.2em;
      --font-family: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-dark);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.7;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    h1, h2, h3 {
      color: var(--text-dark);
    }

    h1 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    .logo {
      display: inline-block;
      margin-right: 10px;
      color: #FFD700;
      font-size: 1.5em;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 1.4rem;
      font-weight: 600;
      color: #4a3a32;
    }

    .card-subtitle {
      text-align: center;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .question-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .question-item {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }

    .question-item input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }

    .question-text {
      font-size: 1rem;
      color: var(--text-dark);
    }

    .btn {
      display: block;
      width: 240px;
      margin: 30px auto 0;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
    }

    .btn-green {
      background: var(--btn-green);
    }

    .btn-green:hover {
      background: #45a049;
    }

    .btn-blue {
      background: var(--btn-blue);
    }

    .btn-blue:hover {
      background: #1976d2;
    }

    .deep-card {
      border: 2px solid var(--btn-blue);
      background: transparent;
      padding: 30px;
    }

    .result-container {
      margin-top: 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    #deepContainer {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    #optionsBox button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
    }

    #optionsBox button:hover {
      background: #eef2ff;
      border-color: #a3b1ff;
    }

    #yearbookOutput {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #4CAF50;
      white-space: pre-wrap;
      font-family: "Songti SC", serif;
      color: var(--text-dark);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="logo">âœ¨</span> æ¯å£¤ Â· X-TSOS ä¸‰å…ƒçŠ¶æ€</h1>

    <!-- åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ -->
    <div class="card">
      <div class="card-title">
        <span>ğŸŒ±</span> <span>åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        10é¢˜ Â· 2åˆ†é’Ÿ Â· æŠŠæ¡å½“ä¸‹çŠ¶æ€è½®å»“
      </div>
      <form id="tsosForm">
        <ul class="question-list">
          <li class="question-item">
            <input type="checkbox" name="q1" />
            <span class="question-text">æˆ‘å¸¸å› è¿½æ±‚å®Œç¾è€Œè¿Ÿè¿Ÿä¸å¼€å§‹è¡ŒåŠ¨ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q2" />
            <span class="question-text">æˆ‘å¾ˆéš¾å¯¹ä»–äººè¯´â€œä¸â€ï¼Œå³ä½¿è‡ªå·±å·²ç»å¾ˆç´¯ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q3" />
            <span class="question-text">æˆ‘æœ€è¿‘çƒ­æƒ…é«˜æ¶¨ï¼Œä½†æ„Ÿåˆ°èº«å¿ƒç–²æƒ«ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q4" />
            <span class="question-text">é¢å¯¹å˜åŒ–ï¼Œæˆ‘å®¹æ˜“é™·å…¥åå¤æ€è™‘ï¼Œéš¾ä»¥å†³æ–­ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q5" />
            <span class="question-text">æˆ‘ä¹ æƒ¯æŠŠæƒ…ç»ªè—èµ·æ¥ï¼Œè¯´â€œæˆ‘æ²¡äº‹â€ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q6" />
            <span class="question-text">æˆ‘å¯¹å­£èŠ‚æˆ–å¤©æ°”å˜åŒ–ç‰¹åˆ«æ•æ„Ÿï¼ˆå¦‚æ˜¥å›°ã€ç§‹ç‡¥ï¼‰ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q7" />
            <span class="question-text">å³ä½¿æ²¡äººè®¤å¯ï¼Œæˆ‘ä¹Ÿæ„¿æ„åšæŒåšä¸€ä»¶å°äº‹ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q8" />
            <span class="question-text">æˆ‘å¸¸æ„Ÿåˆ°æ€ç»ªçº·é£ï¼Œéš¾ä»¥å®‰é™ä¸‹æ¥ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q9" />
            <span class="question-text">åœ¨äººç¾¤ä¸­ï¼Œæˆ‘å®¹æ˜“å¸æ”¶ä»–äººçš„æƒ…ç»ªï¼Œäº‹åéœ€è¦ç‹¬å¤„æ¢å¤ã€‚</span>
          </li>
          <li class="question-item">
            <input type="checkbox" name="q10" />
            <span class="question-text">æˆ‘ç›¸ä¿¡æ—¥å¸¸çäº‹ä¸­è—ç€æ„ä¹‰ï¼Œå“ªæ€•åªæ˜¯ç…®ä¸€æ¯èŒ¶ã€‚</span>
          </li>
        </ul>
        <button type="submit" class="btn btn-green">
          âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€
        </button>
      </form>
    </div>

    <!-- å…±æ˜¾ Â· æ·±åº¦ç‰ˆ -->
    <div class="card deep-card">
      <div class="card-title">
        <span>ğŸŒŒ</span> <span>å…±æ˜¾ Â· æ·±åº¦ç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        åŠ¨æ€è¿½é—® Â· 42é¢˜èµ· Â· é€¼è¿‘å¿ƒæ€§æœ¬çœŸ
      </div>
      <button type="button" class="btn btn-blue" onclick="initDeepScreening()">
        å¯åŠ¨ã€Œè§‚è±¡å…¥å¾®ã€ä¸‰é˜¶å…±æ˜¾åˆç­›
      </button>
    </div>
  </div>

  <!-- æ·±åº¦ç­›æŸ¥ç•Œé¢ -->
  <div id="deepContainer" style="display:none;">
    <div style="text-align:center; margin-bottom:10px; color:#666;">
      è§‚è±¡å…¥å¾® Â· ç¬¬<span id="stageNum">1</span>é˜¶ | å·²ç­”ï¼š<span id="ansCount">0</span> é¢˜
    </div>
    <div id="questionText" style="font-size:18px; min-height:60px; margin-bottom:20px;"></div>
    <div id="optionsBox"></div>
    
    <!-- è¿”å›æŒ‰é’® -->
    <button id="backBtn" style="
      display: none;
      margin-top: 16px;
      padding: 8px 16px;
      background: #e0e0e0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #555;
    ">â†©ï¸ è¿”å›ä¸Šä¸€é¢˜</button>
  </div>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <div id="result" style="display:none; max-width:800px; margin:0 auto;"></div>
  <div id="yearbookOutput" style="display:none;"></div>

  <script type="module">
    // ========== æ­£ç¡®è·¯å¾„å¯¼å…¥ ==========
    import { DeepScreeningEngine } from './src/engine/DeepScreeningEngine.js';
    const { GuidanceRules_zh } = await import('./src/guidance/rules/zh.js');

    // ========== è¡Œä¸ºæŒ‡å¯¼å¼•æ“ï¼ˆå†…è”ï¼‰ ==========
    function generateGuidanceFromResult(result, options = {}) {
      const { qi, lumin, rhythm } = result;
      const maxCount = options.maxCount || 5;

      const topQi = Object.entries(qi)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 2)
        .map(([k]) => k);
      
      const topLumin = Object.entries(lumin)
        .sort((a, b) => b[1] - a[1])[0]?.[0];

      const matches = [];
      for (const rule of GuidanceRules_zh[rhythm] || []) {
        let score = 0;
        if (rule.lumin === topLumin) score += 2;
        if (topQi.includes(rule.qi[0])) score += 1;
        if (topQi.includes(rule.qi[1])) score += 1;
        if (score > 0) {
          matches.push({ ...rule, score });
        }
      }

      matches.sort((a, b) => b.score - a.score);
      return { suggestions: matches.slice(0, maxCount) };
    }

    // ========== åˆç­›æäº¤ ==========
    document.getElementById('tsosForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const answers = {};
      for (let [key] of formData.entries()) {
        answers[key] = true;
      }

      const btn = e.submitter;
      btn.disabled = true;
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(answers)
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data = await response.json();
        showResult(data);
      } catch (err) {
        console.error('âŒ åˆç­›å¤±è´¥:', err.message);
        alert('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜');
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
      }
    });

    // ========== æ·±åº¦ç­›æŸ¥ ==========
    let deepEngine = null;

    window.initDeepScreening = async function() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('deepContainer').style.display = 'block';

      deepEngine = new DeepScreeningEngine();
      try {
        await deepEngine.loadQuestionBank('./data/DQ420.json');
        renderCurrentQuestion();
      } catch (err) {
        alert('é¢˜åº“åŠ è½½å¤±è´¥ï¼š' + err.message);
        console.error(err);
      }
    };

    function renderCurrentQuestion() {
      const q = deepEngine.getCurrentQuestion();
      if (!q || deepEngine.isCompleted()) {
        finishDeepScreening();
        return;
      }

      // æ›´æ–°é¢˜ç›®ã€é˜¶æ®µã€ç­”é¢˜æ•°
      document.getElementById('questionText').textContent = q.text;
      document.getElementById('stageNum').textContent = q.stage || 1;
      document.getElementById('ansCount').textContent = deepEngine.answerHistory.length;

      // æ¸²æŸ“é€‰é¡¹
      const optsBox = document.getElementById('optionsBox');
      optsBox.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.textContent = opt.label || opt;
        btn.onclick = () => {
          deepEngine.submitAnswer(idx);
          renderCurrentQuestion(); // è‡ªåŠ¨å¤„ç†å…œåº•/å®Œæˆ
        };
        optsBox.appendChild(btn);
      });

      // æ›´æ–°â€œè¿”å›â€æŒ‰é’®çŠ¶æ€
      const backBtn = document.getElementById('backBtn');
      backBtn.style.display = deepEngine.canGoBack() ? 'inline-block' : 'none';
    }

    // ========== æ–°å¢ï¼šè¿”å›ä¸Šä¸€é¢˜ ==========
    document.getElementById('backBtn').addEventListener('click', () => {
      if (deepEngine && deepEngine.goBack()) {
        renderCurrentQuestion();
      }
    });

    function finishDeepScreening() {
      const result = deepEngine.getNormalizedResult();
      showResult(result);
    }

    // ========== ç»“æœå±•ç¤º ==========
    function showResult(data) {
      document.getElementById('deepContainer').style.display = 'none';
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<h2 style="text-align:center;">ğŸ“Š ä½ çš„ X-TSOS ä¸‰å…ƒç»“æ„</h2>';

      // å…«ç‚é›·è¾¾å›¾
      const qiCtx = document.createElement('canvas');
      qiCtx.height = 200;
      resultDiv.appendChild(qiCtx);
      new Chart(qiCtx, {
        type: 'radar',
        data: {
          labels: ['åšè½½','èŒåŠ¨','ç‚æ˜','æ¶¦ä¸‹','è‚ƒé™','åˆšå¥','é€šé€','é™å®ˆ'],
          datasets: [{
            label: 'å…«ç‚ç„åŸº',
            data: Object.values(data.qi),
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            pointBackgroundColor: 'rgba(76, 175, 80, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // äº”è§‰å…‰è½®
      const luminCtx = document.createElement('canvas');
      luminCtx.height = 150;
      resultDiv.appendChild(luminCtx);
      new Chart(luminCtx, {
        type: 'radar',
        data: {
          labels: ['å¦‚æ˜¯','ç ´æš—','æ¶“æµ','æ˜ ç…§','æ— å '],
          datasets: [{
            label: 'äº”è§‰å…‰è½®',
            data: Object.values(data.lumin),
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            pointBackgroundColor: 'rgba(33, 150, 243, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // è¡Œä¸ºæŒ‡å¼•
      const guidance = generateGuidanceFromResult(data, { maxCount: 3 });
      const guideEl = document.createElement('div');
      guideEl.innerHTML = `<h3 style="margin-top:30px;">ğŸ’¡ åˆæ­¥è¡Œä¸ºæŒ‡å¯¼</h3>`;
      guidance.suggestions.forEach(sug => {
        const p = document.createElement('p');
        p.innerHTML = `<strong>â†’ ${sug.forward}</strong>`;
        if (sug.reverse) {
          p.innerHTML += `<br><small style="color:#888;">ğŸš« ${sug.reverse}</small>`;
        }
        p.style.margin = '12px 0';
        p.style.padding = '10px';
        p.style.background = '#fafafa';
        p.style.borderRadius = '6px';
        guideEl.appendChild(p);
      });
      resultDiv.appendChild(guideEl);

      // å¹´é‰´æŒ‰é’®
      const yearbookBtn = document.createElement('button');
      yearbookBtn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      yearbookBtn.className = 'btn btn-green';
      yearbookBtn.style.width = 'auto';
      yearbookBtn.style.margin = '20px auto';
      yearbookBtn.onclick = () => generateYearbook(data);
      resultDiv.appendChild(yearbookBtn);
    }

    // ========== å¹´é‰´ç”Ÿæˆ ==========
    async function generateYearbook(tsData) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ğŸ–‹ï¸ æ’°å†™ä¸­...';

      try {
        const response = await fetch('/api/yearbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            qi: tsData.qi,
            lumin: tsData.lumin,
            rhythm: tsData.rhythm
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');

        const output = document.getElementById('yearbookOutput');
        output.textContent = result.yearbook;
        output.style.display = 'block';
      } catch (err) {
        alert('ğŸ“œ å¹´é‰´ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      }
    }
  </script>
</body>
</html>
