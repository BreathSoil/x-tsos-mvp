<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€</title>
  <!-- ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-primary: #fdf6e3;
      --card-bg: white;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.05);
      --border-color: #d9d9d9;
      --text-dark: #2d2d2d;
      --text-light: #666;
      --btn-green: #4CAF50;
      --btn-blue: #2196F3;
      --icon-size: 1.2em;
      --font-family: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-dark);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.7;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    h1, h2, h3 {
      color: var(--text-dark);
    }

    h1 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    .logo {
      display: inline-block;
      margin-right: 10px;
      color: #FFD700;
      font-size: 1.5em;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 1.4rem;
      font-weight: 600;
      color: #4a3a32;
    }

    .card-subtitle {
      text-align: center;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .question-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .question-item {
      margin-bottom: 16px;
    }

    .question-text {
      font-size: 1rem;
      color: var(--text-dark);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .option-btn {
      padding: 10px 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option-btn:hover {
      background: #eef2ff;
      border-color: #a3b1ff;
    }

    .option-btn.selected {
      background: #e3f2fd;
      border-color: #2196f3;
      font-weight: bold;
    }

    .btn {
      display: block;
      width: 240px;
      margin: 30px auto 0;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
    }

    .btn-green {
      background: var(--btn-green);
    }

    .btn-green:hover {
      background: #45a049;
    }

    .btn-blue {
      background: var(--btn-blue);
    }

    .btn-blue:hover {
      background: #1976d2;
    }

    .deep-card {
      border: 2px solid var(--btn-blue);
      background: transparent;
      padding: 30px;
    }

    #deepContainer {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      display: none;
    }

    #yearbookOutput {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #4CAF50;
      white-space: pre-wrap;
      font-family: "Songti SC", serif;
      color: var(--text-dark);
      display: none;
    }

    #tsi-panel, #decision-card {
      margin-top: 24px;
      padding: 16px;
      border-radius: 12px;
    }
    #tsi-fill {
      height: 10px;
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    canvas {
      max-width: 100%;
      height: auto !important;
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <h1><span class="logo">âœ¨</span> æ¯å£¤ Â· X-TSOS ä¸‰å…ƒçŠ¶æ€</h1>

    <!-- åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ -->
    <div class="card">
      <div class="card-title">
        <span>ğŸŒ±</span> <span>åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        10é¢˜ Â· 2åˆ†é’Ÿ Â· æŠŠæ¡å½“ä¸‹çŠ¶æ€è½®å»“
      </div>
      <form id="tsosForm">
        <div id="quickQuestions"></div>
        <button type="submit" class="btn btn-green" id="submitBtn">
          âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€
        </button>
      </form>
    </div>

    <!-- å…±æ˜¾ Â· æ·±åº¦ç‰ˆ -->
    <div class="card deep-card">
      <div class="card-title">
        <span>ğŸŒŒ</span> <span>å…±æ˜¾ Â· æ·±åº¦ç‰ˆ</span>
      </div>
      <div class="card-subtitle">
        åŠ¨æ€è¿½é—® Â· 42é¢˜èµ· Â· é€¼è¿‘å¿ƒæ€§æœ¬çœŸ
      </div>
      <button type="button" class="btn btn-blue" onclick="initDeepScreening()">
        å¯åŠ¨ã€Œè§‚è±¡å…¥å¾®ã€ä¸‰é˜¶å…±æ˜¾åˆç­›
      </button>
    </div>
  </div>

  <!-- æ·±åº¦ç­›æŸ¥ç•Œé¢ -->
  <div id="deepContainer">
    <div style="text-align:center; margin-bottom:10px; color:#666;">
      è§‚è±¡å…¥å¾® Â· ç¬¬<span id="stageNum">1</span>é˜¶ | å·²ç­”ï¼š<span id="ansCount">0</span> é¢˜
    </div>
    <div id="questionText" style="font-size:18px; min-height:60px; margin-bottom:20px;"></div>
    <div id="optionsBox"></div>
    
    <button id="backBtn" style="
      display: none;
      margin-top: 16px;
      padding: 8px 16px;
      background: #e0e0e0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #555;
    ">â†©ï¸ è¿”å›ä¸Šä¸€é¢˜</button>
  </div>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <div id="result" style="display:none; max-width:800px; margin:0 auto;"></div>
  <div id="yearbookOutput"></div>

  <!-- ESM æ¨¡å—åŠ è½½ï¼šå¼•æ“ + å¼•å¯¼ç”Ÿæˆå™¨ -->
  <script type="module">
    // âœ… å¯¼å…¥å®˜æ–¹å¼•æ“ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
    import { DeepScreeningEngine } from '/src/engine/DeepScreeningEngine.js';
    import generateGuidanceFromResult from '/src/guidance/GuidanceEngine.js';

    // æŒ‚è½½åˆ° window ä¾›å…¨å±€å‡½æ•°ä½¿ç”¨
    window.DeepScreeningEngine = DeepScreeningEngine;
    window.generateGuidanceFromResult = generateGuidanceFromResult;

    // ========== å…¨å±€å˜é‡ ==========
    let DQ420 = null;
    let quickQuestions = [];
    let deepEngine = null;

    // ========== åŠ è½½é¢˜åº“ ==========
    async function loadQuestionBank() {
      try {
        const res = await fetch('/data/DQ420.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        DQ420 = await res.json();
        
        // å›ºå®šå–å‰10é¢˜ç”¨äºå¿«é€Ÿç‰ˆ
        const allIds = Object.keys(DQ420);
        quickQuestions = allIds.slice(0, 10);

        renderQuickQuestions();
      } catch (err) {
        console.error('âŒ é¢˜åº“åŠ è½½å¤±è´¥:', err);
        document.getElementById('submitBtn').disabled = true;
        alert('âš ï¸ é¢˜åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»ç®¡ç†å‘˜');
      }
    }

    // ========== æ¸²æŸ“å¿«é€Ÿç‰ˆé¢˜ç›® ==========
    function renderQuickQuestions() {
      if (!DQ420 || quickQuestions.length === 0) return;

      const container = document.getElementById('quickQuestions');
      container.innerHTML = '';

      quickQuestions.forEach(qid => {
        const q = DQ420[qid];
        if (!q || !q.text || !q.options) return;

        const item = document.createElement('div');
        item.className = 'question-item';
        item.innerHTML = `<div class="question-text">${q.text}</div><div class="options" id="opts-${qid}"></div>`;
        container.appendChild(item);

        const optsDiv = document.getElementById(`opts-${qid}`);
        q.options.forEach((opt, idx) => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.textContent = opt.label || opt.text || opt;
          btn.onclick = () => {
            const siblings = optsDiv.querySelectorAll('.option-btn');
            siblings.forEach(s => s.classList.remove('selected'));
            btn.classList.add('selected');
            window.quickAnswers = window.quickAnswers || {};
            window.quickAnswers[qid] = idx;
          };
          optsDiv.appendChild(btn);
        });
      });
    }

    // ========== æäº¤å¿«é€Ÿç‰ˆ ==========
    document.getElementById('tsosForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const answers = window.quickAnswers || {};
      const unanswered = quickQuestions.filter(qid => answers[qid] === undefined);
      if (unanswered.length > 0) {
        alert('è¯·å›ç­”æ‰€æœ‰é—®é¢˜åå†æäº¤');
        return;
      }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(answers)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`æœåŠ¡å¼‚å¸¸ï¼š${errorText}`);
        }

        const resultData = await response.json();
        showResult(resultData);
      } catch (err) {
        console.error('âŒ è¯·æ±‚å¤±è´¥:', err);
        alert('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + (err.message || 'è¯·ç¨åé‡è¯•'));
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
      }
    });

    // ========== æ·±åº¦ç­›æŸ¥ ==========
    window.initDeepScreening = async function() {
      document.getElementById('mainContainer').style.display = 'none';
      document.getElementById('deepContainer').style.display = 'block';

      deepEngine = new DeepScreeningEngine();

      try {
        // âœ… ä½¿ç”¨ç»å¯¹è·¯å¾„ /data/
        await deepEngine.loadQuestionBank('/data/DQ420.json');
        console.log('âœ… æ·±åº¦ç­›æŸ¥é¢˜åº“åŠ è½½æˆåŠŸ');
        renderCurrentQuestion(); // âœ… å…³é”®ï¼šæ¸²æŸ“ç¬¬ä¸€é¢˜
      } catch (err) {
        console.error('âŒ æ·±åº¦ç­›æŸ¥é¢˜åº“åŠ è½½å¤±è´¥:', err);
        alert('æ·±åº¦ç­›æŸ¥é¢˜åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚');
        document.getElementById('deepContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
      }
    };

    function renderCurrentQuestion() {
      if (!deepEngine) return;
      const q = deepEngine.getCurrentQuestion();
      if (!q || deepEngine.isCompleted()) {
        finishDeepScreening();
        return;
      }

      document.getElementById('questionText').textContent = q.text;
      document.getElementById('stageNum').textContent = q.stage || 1;
      document.getElementById('ansCount').textContent = deepEngine.getAnswerCount();

      const optsBox = document.getElementById('optionsBox');
      optsBox.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt.label;
        btn.onclick = () => {
          deepEngine.submitAnswer(idx);
          renderCurrentQuestion();
        };
        optsBox.appendChild(btn);
      });

      document.getElementById('backBtn').style.display = deepEngine.canGoBack() ? 'inline-block' : 'none';
    }

    // ç»‘å®šè¿”å›æŒ‰é’®
    document.getElementById('backBtn').addEventListener('click', () => {
      if (deepEngine && deepEngine.goBack()) {
        renderCurrentQuestion();
      }
    });

    async function finishDeepScreening() {
      const answers = deepEngine.getFinalAnswers();

      const btn = document.createElement('button');
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆæ·±åº¦æŠ¥å‘Š...';
      btn.style.cssText = 'margin:20px auto; display:block;';
      document.getElementById('deepContainer').appendChild(btn);

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(answers)
        });

        if (!response.ok) throw new Error('æ·±åº¦è¯„ä¼°å¤±è´¥');

        const resultData = await response.json();
        document.getElementById('deepContainer').style.display = 'none';
        showResult(resultData);
      } catch (err) {
        console.error('æ·±åº¦ç­›æŸ¥å¤±è´¥:', err);
        alert('æ·±åº¦è¯„ä¼°å‡ºé”™ï¼š' + err.message);
        document.getElementById('deepContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
      }
    }

    // ========== ç»“æœå±•ç¤º ==========
    function showResult(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<h2 style="text-align:center;">ğŸ“Š ä½ çš„ X-TSOS ä¸‰å…ƒç»“æ„</h2>';

      const meta = data.metadata || {};
      const solarTerm = meta.solarTerm || 'æœªçŸ¥';
      const dominantQi = meta.dominantQi || 'æœªè¯†åˆ«';
      resultDiv.innerHTML += `
        <p style="text-align:center; color:#64748b; margin:10px 0;">
          <small>ğŸ“ å½“å‰èŠ‚æ°”ï¼š${solarTerm} Â· ä¸»å¯¼ç‚ï¼š${dominantQi}</small>
        </p>
      `;

      // å…«ç‚é›·è¾¾å›¾
      const qiCtx = document.createElement('canvas');
      qiCtx.height = 300;
      resultDiv.appendChild(qiCtx);
      new Chart(qiCtx, {
        type: 'radar',
        data: {
          labels: ['åšè½½','èŒåŠ¨','ç‚æ˜','æ¶¦ä¸‹','è‚ƒé™','åˆšå¥','é€šé€','é™å®ˆ'],
          datasets: [{
            label: 'å…«ç‚ç„åŸº',
            data: Object.values(data.qi),
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            pointBackgroundColor: 'rgba(76, 175, 80, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // äº”è§‰å…‰è½®
      const luminCtx = document.createElement('canvas');
      luminCtx.height = 250;
      resultDiv.appendChild(luminCtx);
      new Chart(luminCtx, {
        type: 'radar',
        data: {
          labels: ['å¦‚æ˜¯','ç ´æš—','æ¶“æµ','æ˜ ç…§','æ— å '],
          datasets: [{
            label: 'äº”è§‰å…‰è½®',
            data: Object.values(data.lumin),
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            pointBackgroundColor: 'rgba(33, 150, 243, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // TSI ä¸å†³ç­–å¡
      if (data.TSI !== undefined) {
        const tsiPercent = Math.round(data.TSI * 100);
        let desc = '';
        if (data.TSI < 0.4) {
          desc = 'çŠ¶æ€è„†å¼±ï¼Œå»ºè®®ä¼˜å…ˆè‡ªæˆ‘å…³æ€€ä¸åŸºç¡€æ¥åœ°ç»ƒä¹ ';
        } else if (data.TSI < 0.7) {
          desc = 'çŠ¶æ€å¹³ç¨³ï¼Œå¯å°è¯•æ¸©å’Œè¡ŒåŠ¨æˆ–å¾®ä»»åŠ¡';
        } else {
          desc = 'çŠ¶æ€é«˜èƒ½ï¼Œé€‚åˆæ·±åº¦åˆ›é€ ã€è¡¨è¾¾æˆ–è¿æ¥ä»–äºº';
        }

        const tsiHtml = `
          <div id="tsi-panel" style="background:#f8fafc; border:1px solid #e2e8f0; margin-top:24px; padding:16px; border-radius:12px;">
            <h3 style="margin:0 0 12px 0; color:#1e293b; font-size:1.1em;">ä¸‰å…ƒååŒåº¦ (TSI)</h3>
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
              <div style="flex:1; height:10px; background:#e2e8f0; border-radius:5px; overflow:hidden;">
                <div id="tsi-fill" style="height:100%; background:linear-gradient(to right, #f87171, #60a5fa, #34d399); width:${tsiPercent}%;"></div>
              </div>
              <span style="font-weight:bold; min-width:50px; text-align:right;">${tsiPercent}%</span>
            </div>
            <p style="margin:0; font-size:0.9em; color:#64748b;">${desc}</p>
          </div>

          <div id="decision-card" style="margin-top:16px; padding:14px; background:#f1f5f9; border-radius:10px; border-left:4px solid #4f46e5;">
            <strong style="color:#1e293b;">ä¸ºä½•æ­¤åˆ»æ¨èæ­¤æŒ‡å¼•ï¼Ÿ</strong><br>
            <span style="color:#334155;">${data.decisionCard?.reason || 'ç³»ç»Ÿæ­£åœ¨å­¦ä¹ ä½ çš„çŠ¶æ€æ¨¡å¼...'}</span><br>
            <small style="color:#64748b; margin-top:6px; display:block;">${data.decisionCard?.action || ''}</small>
          </div>
        `;
        resultDiv.innerHTML += tsiHtml;
      }

      // å¹´é‰´æŒ‰é’®
      const yearbookBtn = document.createElement('button');
      yearbookBtn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      yearbookBtn.className = 'btn btn-green';
      yearbookBtn.style.width = 'auto';
      yearbookBtn.style.margin = '20px auto';
      yearbookBtn.onclick = () => {
        const yearbookText = `ã€ä¸‰å…ƒå¹´é‰´ Â· ${new Date().getFullYear()}ã€‘\n\nä¸»å¯¼ç‚ï¼š${dominantQi}\nèŠ‚æ°”è¯­å¢ƒï¼š${solarTerm}\nTSIï¼š${(data.TSI * 100).toFixed(1)}%\n\nâ€”â€” æ¯å£¤ Â· X-TSOS`;
        document.getElementById('yearbookOutput').textContent = yearbookText;
        document.getElementById('yearbookOutput').style.display = 'block';
      };
      resultDiv.appendChild(yearbookBtn);
    }

    // ========== å¯åŠ¨ ==========
    loadQuestionBank();
  </script>
</body>
</html>
