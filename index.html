<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "PingFang SC", "Helvetica Neue", sans-serif;
      background: #fdf6e3;
      color: #333;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #5a4a42;
      font-size: 2rem;
      margin-bottom: 30px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .question {
      display: flex;
      align-items: center;
      margin: 12px 0;
      padding-left: 24px;
      position: relative;
    }
    .question::before {
      content: "âœ…";
      position: absolute;
      left: 0;
      color: #7d6608;
      font-weight: bold;
    }
    .question input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }
    .question label {
      font-size: 1.1rem;
      cursor: pointer;
    }
    button {
      display: block;
      margin: 30px auto 20px;
      padding: 12px 30px;
      font-size: 1.1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button:hover { background: #45a049; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    #result, #yearbookOutput {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #yearbookOutput {
      background: #f9f7f0;
      display: none;
      white-space: pre-wrap;
      line-height: 1.7;
    }
    .error { color: #d32f2f; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>âœ¨ æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€åˆç­›</h1>

  <form id="tsosForm">
    <div class="question">
      <label><input type="checkbox" name="q1" /> ç‚æ˜æ˜¾è‘—ï¼ˆè¡ŒåŠ¨åŠ›å¼ºï¼Œç›®æ ‡æ˜ç¡®ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q2" /> æ½œå¹½å€¾å‘ï¼ˆå†…çœæ·±æ²‰ï¼Œå–œé™æ€ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q3" /> èŒåŠ¨æ´»è·ƒï¼ˆåˆ›æ„æ¶Œç°ï¼Œå˜åŒ–ä¸å±…ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q4" /> åšè½½ç¨³å®šï¼ˆåŒ…å®¹æ‹…å½“ï¼ŒæŒå®ˆå¦‚ä¸€ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q5" /> é€šé€æ•é”ï¼ˆæ´å¯Ÿæœ¬è´¨ï¼Œç›´è§‰æ¸…æ™°ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q6" /> åˆšå¥ç†æ€§ï¼ˆé€»è¾‘ä¸¥è°¨ï¼Œæ„å¿—åšå®šï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q7" /> é™å®ˆåŒæ­¥ï¼ˆèŠ‚å¥è‡ªæ²»ï¼Œä¸éšå¤–æ‰°ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q8" /> å’Œåˆåè°ƒï¼ˆå…³ç³»èé€šï¼Œå–„è°ƒçŸ›ç›¾ï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q9" /> è§†è§‰ä¸»å¯¼ï¼ˆå›¾åƒæ€ç»´ï¼Œç©ºé—´æ•æ„Ÿï¼‰</label>
    </div>
    <div class="question">
      <label><input type="checkbox" name="q10" /> å¬è§‰æ•æ„Ÿï¼ˆéŸ³å¾‹è¾¨è¯†ï¼Œè¯­è¨€æ•æ‰å¼ºï¼‰</label>
    </div>
    <button type="submit">âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€</button>
  </form>

  <div id="result" style="display:none;"></div>
  <div id="yearbookOutput"></div>

  <script>
    document.getElementById('tsosForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const answers = {};
      for (let [key] of formData.entries()) {
        answers[key] = true;
      }

      const btn = e.submitter;
      btn.disabled = true;
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(answers)
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');

        renderResult(data);
      } catch (err) {
        showError('âŒ ' + (err.message || 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'));
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
      }
    });

    function renderResult(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<h2>ğŸ“Š ä½ çš„ X-TSOS ä¸‰å…ƒç»“æ„</h2>';

      // å…«ç‚é›·è¾¾å›¾
      const qiCtx = document.createElement('canvas');
      qiCtx.height = 300;
      resultDiv.appendChild(qiCtx);

      new Chart(qiCtx, {
        type: 'radar',
        data: {
          labels: ['åšè½½','èŒåŠ¨','ç‚æ˜','æ¶¦ä¸‹','è‚ƒé™','åˆšå¥','é€šé€','é™å®ˆ'],
          datasets: [{
            label: 'å…«ç‚ç„åŸº',
            data: [
              data.qi.åšè½½,
              data.qi.èŒåŠ¨,
              data.qi.ç‚æ˜,
              data.qi.æ¶¦ä¸‹,
              data.qi.è‚ƒé™,
              data.qi.åˆšå¥,
              data.qi.é€šé€,
              data.qi.é™å®ˆ
            ],
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            pointBackgroundColor: 'rgba(76, 175, 80, 1)'
          }]
        },
        options: {
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 20 }
            }
          },
          plugins: { legend: { display: false } }
        }
      });

      // äº”è§‰å…‰è½®
      const luminCtx = document.createElement('canvas');
      luminCtx.height = 250;
      resultDiv.appendChild(luminCtx);

      new Chart(luminCtx, {
        type: 'radar',
        data: {
          labels: ['å¦‚æ˜¯','ç ´æš—','æ¶“æµ','æ˜ ç…§','æ— å '],
          datasets: [{
            label: 'äº”è§‰å…‰è½®',
            data: [
              data.lumin.å¦‚æ˜¯,
              data.lumin.ç ´æš—,
              data.lumin.æ¶“æµ,
              data.lumin.æ˜ ç…§,
              data.lumin.æ— å 
            ],
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            pointBackgroundColor: 'rgba(33, 150, 243, 1)'
          }]
        },
        options: {
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 20 }
            }
          },
          plugins: { legend: { display: false } }
        }
      });

      // å¹´é‰´æŒ‰é’®
      const yearbookBtn = document.createElement('button');
      yearbookBtn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      yearbookBtn.onclick = () => generateYearbook(data);
      yearbookBtn.style.marginTop = '20px';
      resultDiv.appendChild(yearbookBtn);
    }

    async function generateYearbook(tsData) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ğŸ–‹ï¸ æ’°å†™ä¸­...';

      try {
        const response = await fetch('/api/yearbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            qi: tsData.qi,
            lumin: tsData.lumin,
            rhythm: tsData.rhythm
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');

        const output = document.getElementById('yearbookOutput');
        output.textContent = result.yearbook;
        output.style.display = 'block';
      } catch (err) {
        showError('ğŸ“œ å¹´é‰´ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      }
    }

    function showError(msg) {
      let el = document.querySelector('.error');
      if (!el) {
        el = document.createElement('div');
        el.className = 'error';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      setTimeout(() => el.remove(), 5000);
    }
  </script>
</body>
</html>
