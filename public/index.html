<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Helvetica Neue", "PingFang SC", sans-serif;
      background: #fdf6e3;
      color: #333;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #5a4a42;
    }
    .mode-box {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      background: white;
    }
    .deep-mode {
      border-color: #2196F3;
      background: #f9f9ff;
    }
    .question { margin: 12px 0; }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: normal;
      cursor: pointer;
    }
    input[type="checkbox"] {
      margin-right: 8px;
    }
    button {
      display: block;
      margin: 20px auto;
      padding: 12px 24px;
      font-size: 18px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .deep-btn {
      background: #2196F3;
    }
    button:hover { opacity: 0.9; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    #result, #yearbookOutput, #deepContainer {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #deepContainer {
      background: #f0f7ff;
      display: none;
    }
    #optionsBox button {
      width: 100%;
      text-align: left;
      padding: 12px;
      margin: 8px 0;
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 4px;
    }
    #yearbookOutput {
      background: #f9f7f0;
      display: none;
      white-space: pre-wrap;
      line-height: 1.7;
    }
    .error { 
      color: #d32f2f; 
      margin-top: 10px; 
      text-align: center;
    }
    .stage-indicator {
      text-align: center;
      color: #2196F3;
      font-weight: bold;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h1>âœ¨ æ¯å£¤Â·X-TSOS ä¸‰å…ƒçŠ¶æ€åˆç­›</h1>

  <!-- ========== åŒæ¨¡å¼é€‰æ‹© ========== -->
  <div id="modeSelector">
    <!-- è½»é—®æ¨¡å¼ -->
    <div class="mode-box">
      <h2>ğŸŒ± åˆæ„Ÿ Â· å¿«é€Ÿç‰ˆ</h2>
      <p style="text-align:center; margin-bottom:15px;">10é¢˜ Â· 2åˆ†é’Ÿ Â· æŠŠæ¡å½“ä¸‹çŠ¶æ€è½®å»“</p>
      <form id="tsosForm">
        <div class="question">
          <label><input type="checkbox" name="q1"> æˆ‘å¸¸å› è¿½æ±‚å®Œç¾è€Œè¿Ÿè¿Ÿä¸å¼€å§‹è¡ŒåŠ¨ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q2"> æˆ‘å¾ˆéš¾å¯¹ä»–äººè¯´â€œä¸â€ï¼Œå³ä½¿è‡ªå·±å·²ç»å¾ˆç´¯ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q3"> æˆ‘æœ€è¿‘çƒ­æƒ…é«˜æ¶¨ï¼Œä½†æ„Ÿåˆ°èº«å¿ƒç–²æƒ«ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q4"> é¢å¯¹å˜åŒ–ï¼Œæˆ‘å®¹æ˜“é™·å…¥åå¤æ€è™‘ï¼Œéš¾ä»¥å†³æ–­ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q5"> æˆ‘ä¹ æƒ¯æŠŠæƒ…ç»ªè—èµ·æ¥ï¼Œè¯´â€œæˆ‘æ²¡äº‹â€ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q6"> æˆ‘å¯¹å­£èŠ‚æˆ–å¤©æ°”å˜åŒ–ç‰¹åˆ«æ•æ„Ÿï¼ˆå¦‚æ˜¥å›°ã€ç§‹ç‡¥ï¼‰ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q7"> å³ä½¿æ²¡äººè®¤å¯ï¼Œæˆ‘ä¹Ÿæ„¿æ„åšæŒåšä¸€ä»¶å°äº‹ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q8"> æˆ‘å¸¸æ„Ÿåˆ°æ€ç»ªçº·é£ï¼Œéš¾ä»¥å®‰é™ä¸‹æ¥ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q9"> åœ¨äººç¾¤ä¸­ï¼Œæˆ‘å®¹æ˜“å¸æ”¶ä»–äººçš„æƒ…ç»ªï¼Œäº‹åéœ€è¦ç‹¬å¤„æ¢å¤ã€‚</label>
        </div>
        <div class="question">
          <label><input type="checkbox" name="q10"> æˆ‘ç›¸ä¿¡æ—¥å¸¸çäº‹ä¸­è—ç€æ„ä¹‰ï¼Œå“ªæ€•åªæ˜¯ç…®ä¸€æ¯èŒ¶ã€‚</label>
        </div>
        <button type="submit">âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€</button>
      </form>
    </div>

    <!-- å…±æ˜¾æ¨¡å¼å…¥å£ -->
    <div class="mode-box deep-mode">
      <h2>ğŸŒŒ å…±æ˜¾ Â· æ·±åº¦ç‰ˆ</h2>
      <p style="text-align:center; margin-bottom:15px;">åŠ¨æ€è¿½é—® Â· 42é¢˜èµ· Â· é€¼è¿‘å¿ƒæ€§æœ¬çœŸ</p>
      <button type="button" class="deep-btn" onclick="initDeepScreening()">
        å¯åŠ¨ã€Œè§‚è±¡å…¥å¾®ã€ä¸‰é˜¶å…±æ˜¾åˆç­›
      </button>
    </div>
  </div>

  <!-- ========== æ·±åº¦ç­”é¢˜å®¹å™¨ ========== -->
  <div id="deepContainer">
    <div class="stage-indicator">è§‚è±¡å…¥å¾® Â· ç¬¬<span id="stageNum">1</span>é˜¶</div>
    <div id="questionText" style="font-size:18px; min-height:60px;"></div>
    <div id="optionsBox"></div>
    <p style="text-align:center; color:#666;">å·²ç­”ï¼š<span id="ansCount">0</span> é¢˜</p>
  </div>

  <!-- ========== ç»“æœåŒºåŸŸ ========== -->
  <div id="result" style="display:none;"></div>
  <div id="yearbookOutput"></div>

  <script type="module">
    // ========== è½»é—®è¡¨å•æäº¤ ==========
    document.getElementById('tsosForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const answers = {};
      for (let [key] of formData.entries()) {
        answers[key] = true;
      }

      const btn = e.submitter;
      btn.disabled = true;
      btn.textContent = 'ğŸŒ€ ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/tsos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(answers)
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');

        showResult(data);
      } catch (err) {
        showError('âŒ ' + (err.message || 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'));
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒçŠ¶æ€';
      }
    });

    // ========== æ·±åº¦æ¨¡å¼å¼•æ“ ==========
    import { DeepScreeningEngine } from '/js/deep-engine.js';

    let deepEngine = null;

    window.initDeepScreening = async function() {
      document.getElementById('modeSelector').style.display = 'none';
      document.getElementById('deepContainer').style.display = 'block';

      deepEngine = new DeepScreeningEngine();
      try {
        await deepEngine.loadQuestionBank();
        renderCurrentQuestion();
      } catch (err) {
        showError('é¢˜åº“åŠ è½½å¤±è´¥ï¼š' + err.message);
        console.error(err);
      }
    };

    function renderCurrentQuestion() {
      const q = deepEngine.getCurrentQuestion();
      if (!q || deepEngine.isCompleted()) {
        finishDeepScreening();
        return;
      }

      document.getElementById('questionText').textContent = q.text;
      const optsBox = document.getElementById('optionsBox');
      optsBox.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.textContent = opt.label || opt;
        btn.onclick = () => {
          deepEngine.submitAnswer(idx);
          document.getElementById('ansCount').textContent = deepEngine.answerCount;
          if (deepEngine.isCompleted()) {
            finishDeepScreening();
          } else {
            renderCurrentQuestion();
          }
        };
        optsBox.appendChild(btn);
      });

      document.getElementById('stageNum').textContent = q.stage || 1;
    }

    function finishDeepScreening() {
      const result = deepEngine.getNormalizedResult();
      showResult(result);
    }

    // ========== ç»“æœæ¸²æŸ“ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰ ==========
    function showResult(data) {
      document.getElementById('deepContainer').style.display = 'none';
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<h2>ğŸ“Š ä½ çš„ X-TSOS ä¸‰å…ƒç»“æ„</h2>';

      // å…«ç‚é›·è¾¾å›¾
      const qiCtx = document.createElement('canvas');
      qiCtx.height = 300;
      resultDiv.appendChild(qiCtx);

      new Chart(qiCtx, {
        type: 'radar',
        data: {
          labels: ['åšè½½','èŒåŠ¨','ç‚æ˜','æ¶¦ä¸‹','è‚ƒé™','åˆšå¥','é€šé€','é™å®ˆ'],
          datasets: [{
            label: 'å…«ç‚ç„åŸº',
            data: [
              data.qi.åšè½½,
              data.qi.èŒåŠ¨,
              data.qi.ç‚æ˜,
              data.qi.æ¶¦ä¸‹,
              data.qi.è‚ƒé™,
              data.qi.åˆšå¥,
              data.qi.é€šé€,
              data.qi.é™å®ˆ
            ],
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            pointBackgroundColor: 'rgba(76, 175, 80, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // äº”è§‰å…‰è½®
      const luminCtx = document.createElement('canvas');
      luminCtx.height = 250;
      resultDiv.appendChild(luminCtx);

      new Chart(luminCtx, {
        type: 'radar',
        data: {
          labels: ['å¦‚æ˜¯','ç ´æš—','æ¶“æµ','æ˜ ç…§','æ— å '],
          datasets: [{
            label: 'äº”è§‰å…‰è½®',
            data: [
              data.lumin.å¦‚æ˜¯,
              data.lumin.ç ´æš—,
              data.lumin.æ¶“æµ,
              data.lumin.æ˜ ç…§,
              data.lumin.æ— å 
            ],
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            pointBackgroundColor: 'rgba(33, 150, 243, 1)'
          }]
        },
        options: {
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });

      // å¹´é‰´æŒ‰é’®
      const yearbookBtn = document.createElement('button');
      yearbookBtn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      yearbookBtn.onclick = () => generateYearbook(data);
      yearbookBtn.style.marginTop = '20px';
      resultDiv.appendChild(yearbookBtn);
    }

    // ========== å¹´é‰´ç”Ÿæˆ ==========
    async function generateYearbook(tsData) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ğŸ–‹ï¸ æ’°å†™ä¸­...';

      try {
        const response = await fetch('/api/yearbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            qi: tsData.qi,
            lumin: tsData.lumin,
            rhythm: tsData.rhythm
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');

        const output = document.getElementById('yearbookOutput');
        output.textContent = result.yearbook;
        output.style.display = 'block';
      } catch (err) {
        showError('ğŸ“œ å¹´é‰´ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“œ ç”Ÿæˆæˆ‘çš„ä¸‰å…ƒå¹´é‰´';
      }
    }

    // ========== é”™è¯¯æç¤º ==========
    function showError(msg) {
      let el = document.querySelector('.error');
      if (!el) {
        el = document.createElement('div');
        el.className = 'error';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      setTimeout(() => el.remove(), 5000);
    }
  </script>
</body>
</html>
